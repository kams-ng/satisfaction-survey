<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Enquête Satisfaction</title>
    <link rel="icon" href="/assets/sfm.ico" type="image/x-icon" />
    <link rel="stylesheet" href="output.css" />
    <style>
      .muted {
        color: var(--color-yellow-500);
        font-size: 13px;
        margin-top: 6px;
      }
      .hidden {
        display: none;
      }

      .msg {
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
      }
      .stars {
        display: inline-flex;
        gap: 6px;
      }
      .star {
        font-size: 22px;
        cursor: pointer;

        user-select: none;
      }
      .ok {
        background: #cff9e1;
        border: 1px solid var(--color-green-500);
      }
      .err {
        background: #fcd7d7;
        border: 1px solid var(--color-red-400);
      }
    </style>
  </head>
  <body class="max-w-lg mx-auto">
    <div class="flex items-center flex-col justify-center">
      <img src="/assets/logo2.png" alt="Logo" class="logo mb-3" />
      <h2 class="font-bold text-xl lg:text-2xl px-4 text-center text-brand">
        Enquête de satisfaction client
      </h2>
    </div>

    <form id="form" class="m-5">
      <div class="mb-5">
        <label for="email" class="block mb-2.5 text-sm font-medium text-heading"
          >Email</label
        >
        <input
          type="email"
          id="email"
          class="bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand block w-full px-3 py-2.5 shadow-xs placeholder:text-body"
          placeholder="client@exemple.com"
          required
        />
      </div>
      <div class="mb-5">
        <label
          for="client_name"
          class="block mb-2.5 text-sm font-medium text-heading"
          >Nom</label
        >
        <input
          type="text"
          id="client_name"
          class="bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand block w-full px-3 py-2.5 shadow-xs placeholder:text-body"
          placeholder="Nom"
          required
        />
      </div>

      <div></div>

      <label class="block mb-2.5 text-sm font-medium text-heading"
        >Projet</label
      >
      <select
        id="project"
        class="block w-full px-3 py-2.5 bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand shadow-xs placeholder:text-body"
        required
      >
        <option value="">-- Sélectionner --</option>
        <option>
          1. Planification de mesures radio – Sites obstrués (Dossier CI) SSV
        </option>
        <option>
          2. Mesures Benchmark CRC Janvier 2026 Douala, Yaounde, Bertoua,
          Sangmelima, Ebolowa
        </option>
        <option>3. Foumbot | 4G ZTE Single/Dual Streaming Beamforming</option>
        <option>4. [External] LMS 4G Huawei DT_Foumbot</option>
        <option>5. [External] LMS 4G Huawei DT_Bafoussam</option>
        <option>
          6. Drive Test Qualification de la LMS-REC :: Douala Cluster 3
        </option>
      </select>

      <div
        class="bg-neutral-primary-soft block max-w-lg my-4 p-6 border border-default rounded-base shadow-xs"
      >
        <!-- Ratings -->
        <div id="ratings"></div>
      </div>
      <div>
        <label class="block mb-2.5 text-sm font-medium text-heading"
          >Commentaire global du projet</label
        >
        <textarea
          id="global_comment"
          placeholder="Votre retour global..."
          rows="4"
          class="bg-neutral-secondary-medium mb-4 border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand block w-full p-3.5 shadow-xs placeholder:text-body"
        ></textarea>
      </div>

      <div class="flex flex-wrap gap-3">
        <button
          type="submit"
          class="text-body bg-neutral-secondary-medium box-border border border-default-medium hover:bg-neutral-tertiary-medium hover:text-heading focus:ring-4 focus:ring-neutral-tertiary shadow-xs font-medium leading-5 rounded-base text-sm px-4 py-2.5 focus:outline-none"
        >
          Soumettre
        </button>
        <button
          type="button"
          class="text-white bg-brand box-border border border-transparent hover:bg-brand-strong focus:ring-4 focus:ring-brand-medium shadow-xs font-medium leading-5 rounded-base text-sm px-4 py-2.5 focus:outline-none"
          id="submitAndNew"
        >
          Soumettre & Nouveau
        </button>
      </div>

      <div id="message" class="msg hidden"></div>
    </form>

    <script>
      const API = "/api";

      const criteria = [
        { key: "reactivity", label: "Réactivité" },
        { key: "deadlines", label: "Conformité des délais" },
        { key: "deliverables", label: "Qualité des livrables" },
        { key: "professionalism", label: "Professionnalisme et innovation" },
      ];

      const ratingsDiv = document.getElementById("ratings");

      function makeRatingBlock(c) {
        const wrap = document.createElement("div");
        const titleAndStars = document.createElement("div");
        titleAndStars.className =
          "flex justify-between gap-2 items-center my-2 flex-wrap";
        wrap.className = "card";
        wrap.style.borderStyle = "dashed";

        const label = document.createElement("div");
        label.style.fontWeight = "700";
        label.textContent = c.label;
        titleAndStars.appendChild(label);

        const stars = document.createElement("div");
        stars.className = "stars";
        titleAndStars.appendChild(stars);
        wrap.appendChild(titleAndStars);

        const value = document.createElement("input");
        value.type = "hidden";
        value.id = c.key;
        value.value = "0";
        wrap.appendChild(value);

        const hint = document.createElement("div");
        hint.className = "muted";
        hint.id = c.key + "_hint";
        hint.textContent = "Note: 0/5";
        wrap.appendChild(hint);

        const sugLabel = document.createElement("label");
        sugLabel.className = "mt-2.5 text-xs hidden text-body";
        sugLabel.textContent = "Suggestion / Justification (si note faible)";
        wrap.appendChild(sugLabel);

        const suggestion = document.createElement("textarea");
        suggestion.id = c.key + "_suggestion";
        suggestion.className =
          "hidden bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base my-2 focus:ring-brand focus:border-brand block w-full p-3.5 shadow-xs placeholder:text-body";
        suggestion.placeholder = "Que faut-il améliorer ?";
        wrap.appendChild(suggestion);

        function render(n) {
          stars.innerHTML = "";
          for (let i = 1; i <= 5; i++) {
            const s = document.createElement("span");
            s.className =
              i <= n ? "star text-yellow-500" : "star text-gray-400";
            s.textContent = i <= n ? "★" : "☆";
            s.onclick = () => {
              value.value = String(i);
              document.getElementById(
                c.key + "_hint"
              ).textContent = `Note: ${i}/5`;
              // suggestion visible if <=3
              suggestion.classList.toggle("hidden", i > 3);
              render(i);
            };
            stars.appendChild(s);
          }
        }

        render(0);
        return wrap;
      }

      criteria.forEach((c) => ratingsDiv.appendChild(makeRatingBlock(c)));

      const msg = document.getElementById("message");
      function showMessage(type, text) {
        msg.className = "msg " + (type === "ok" ? "ok" : "err");
        msg.textContent = text;
        msg.classList.remove("hidden");
      }

      function payloadFromForm() {
        const p = {
          email: document.getElementById("email").value.trim(),
          client_name: document.getElementById("client_name").value.trim(),
          project: document.getElementById("project").value.trim(),
          global_comment: document
            .getElementById("global_comment")
            .value.trim(),
        };

        for (const c of criteria) {
          const v = Number(document.getElementById(c.key).value);
          if (!v || v < 1 || v > 5)
            throw new Error(`Veuillez noter: ${c.label}`);
          p[c.key] = v;

          const sug = document
            .getElementById(c.key + "_suggestion")
            .value.trim();
          p[c.key + "_suggestion"] = sug || "";
        }

        return p;
      }

      async function submit(resetAfter) {
        msg.classList.add("hidden");
        try {
          const data = payloadFromForm();
          const r = await fetch(API + "/feedback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const out = await r.json();
          if (!r.ok)
            throw new Error(out.error || "Erreur lors de la soumission.");

          showMessage("ok", out.message || "Enregistré.");

          if (resetAfter) {
            document.getElementById("project").value = "";
            document.getElementById("global_comment").value = "";
            // reset stars
            criteria.forEach((c) => {
              document.getElementById(c.key).value = "0";
              document.getElementById(c.key + "_hint").textContent =
                "Note: 0/5";
              const sug = document.getElementById(c.key + "_suggestion");
              sug.value = "";
              sug.classList.add("hidden");
            });
            // re-render rating blocks quickly by reloading page section
            ratingsDiv.innerHTML = "";
            criteria.forEach((c) => ratingsDiv.appendChild(makeRatingBlock(c)));
          }
        } catch (e) {
          showMessage("err", e.message);
        }
      }

      document.getElementById("form").addEventListener("submit", (e) => {
        e.preventDefault();
        submit(false);
      });

      document.getElementById("submitAndNew").addEventListener("click", () => {
        submit(true);
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@4.0.1/dist/flowbite.min.js"></script>
  </body>
</html>
